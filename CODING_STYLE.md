## エド - コーディング規約（Python / PySide6）

対象: このリポジトリの Python コード（UI/LLM/設定/メモリまわりを含む）

### 1. 言語・バージョン・依存
- Python 3.10 以上を前提
- 原則として型ヒント（typing）を付ける（公開関数・メソッド・戻り値・引数）
- `print` は使用しない。ログは `logging` を使用（INFO 以上、`app.pyw` のローテーション設定に従う）

### 2. 命名規則
- 変数: 名詞（詳細で意味の分かる名前。`n`, `x1` などは不可）
- 関数/メソッド: 動詞または動詞句（`update_position`, `apply_config`）
- クラス: 名詞/名詞句（`DesktopMascot`, `SettingsWindow`）
- 定数: UPPER_SNAKE_CASE（`SOME_LIMIT`）
- プライベート属性/関数は `_` プレフィックス（例: `_reset_anim_timer_for_state`）

### 3. フォーマット・スタイル
- PEP8 をベースに以下を採用
  - 行長の目安は 100 列（長くなる場合は改行・補助変数で分割）
  - 早期 return でネストを浅く保つ
  - 複雑な三項演算子は禁止。可読性を優先
- 文字列は f-string を優先（format は互換性の都合のみ）
- 例外は握り潰さない。どうしても無視する場合は理由をコメントで明示

### 4. 例外・エラーハンドリング
- 広すぎる `except Exception` は避ける。必要な場合は
  - 最小限の保護範囲に限定
  - ログへ `logging.exception(...)` で原因を残す
- UI スレッドが止まる処理では try/finally で後片付けを保証

### 5. ログ
- ルートロガーは `app.pyw` で初期化済み（ファイル + コンソール）
- ライブラリ的コードでは `logging.getLogger(__name__)` を使用
- ユーザー入力/外部APIレスポンスの全文はログに残さない（先頭一部のプレビュー等）

### 6. 型・docstring
- 公開 API（モジュール外から呼ばれる可能性がある関数・メソッド）は型注釈必須
- 複雑な処理のみ docstring を付与（Google スタイル推奨）

```python
def load_image(path: Path) -> QPixmap | None:
    """画像を読み込み、キャンバスに収まるよう調整して返す。
    Returns:
        QPixmap | None: 読み込み失敗時は None
    """
```

### 7. コントロールフロー
- ガード節で早期 return。二重以上の深い if ネストを避ける
- ループ内で複数条件が絡む場合は、条件を説明する補助変数を置く

### 8. PySide6 / UI の約束
- UI 操作は UI スレッドで行う。ワーカースレッドからは Signal/Slot 経由
- ウィンドウの前面化・位置追従などはチラつきを避ける工夫（閾値・スロットリング）を入れる
- 透過ウィンドウや角丸は「スタイルシートの border-radius」に加え、必要に応じてウィンドウマスクを使用
- スタイルシートのセレクタは `objectName` やカスタムプロパティを活用（`QLabel#msg[chatRole="user"]` 等）
- 重い描画処理（画像変換など）はキャッシュする（例: ミラー済みピクスの `_mirror_cache`）

### 9. スレッド/非同期
- LLM 呼び出し・音声処理など重い処理は UI スレッド外で実行。結果は Signal で UI へ
- タイムアウトやキャンセルを考慮し、タイマーで UI をブロックしない

### 10. 設定・定数
- 設定値は `agent.config.load_config()` を経由。ハードコードしない
- UI で変更された値は `save_config()` で JSON に保存し、再読込で即時反映

### 11. LLM 連携
- 必ず `agent.llm.chat()` を経由。`llm.enabled` が false の時はフォールバック動作にする
- ユーザーへ表示する前に内部タグやコードフェンスを除去（`Talker._sanitize_for_display` 相当）
- 日本語で簡潔に返す（必要時に翻訳）

### 12. メモリ・データ
- `MemoryStore` 経由で保存。サイズ上限を守る（設定の `max_history`, `max_summary_chars`）
- `data/` は Git で追跡しない（ランタイムデータ）。必要なら初期データのみ個別に追加

### 13. 依存・パッケージ
- 新規依存は `requirements.txt` に追加（可能な限り最新安定版、互換範囲は `>=` で指定）
- ネイティブ拡張に依存するライブラリは導入理由と代替案を README に追記

### 14. テスト・動作確認（軽量）
- UI はスナップショットテストを想定しづらいので最小限の単体テストを優先（ユーティリティ、分類ロジック等）
- 再現手順がある不具合は `logs/edo.log` の抜粋を添付

### 15. Git 運用・コミットメッセージ
- 原則として 1 変更 = 1 コミット（UI とロジックの大規模変更は分割）
- コミットメッセージ（日本語・現在形/命令形）
  - 先頭語: `feat:`, `fix:`, `refactor:`, `perf:`, `docs:`, `chore:`
  - 例: `fix: チャットパネルの角丸マスクが消える問題を修正`
- 機微情報（APIキー等）はコミットしない。設定は `config/mascot.json` の空欄を想定

### 16. UI/アニメ資産
- 画像は `material/` 配下。状態別にサブフォルダ名やファイル名にキーワードを含める
  - `walk`, `idle`, `sleep`, `float` を自動分類（`float_*` はドラッグ中アニメ）
- 新規アニメは解像度・基準（底辺合わせ）を既存に合わせる

### 17. コメント規約
- 原則: 「何を」ではなく「なぜ」を書く。読者は熟練開発者を想定し、自明な説明は書かない。
- 書くべき内容（例）
  - 非直感的な仕様・制約（Qt/OSの制約、フォーカス・前面化の癖、透過ウィンドウのマスク理由）
  - 重要な前提・不変条件・トレードオフ（性能優先/チラつき回避のための閾値など）
  - 外部APIの挙動差やワークアラウンド（期限付きなら理由と撤去条件）
  - 例外を握る場合の明確な理由（ユーザー体験保護のためなど）
- 書かないこと
  - コードの逐語的説明・当たり前のこと（「ループを回す」「1を足す」など）
  - TODO の置きっぱなし（Issue/タスク管理に切り出す。コード内には残さない）
  - ログにすべき運用情報（実行時の可観測性はログへ）
- 形式
  - 行コメント: `#` の後に短い文。理由→結果の順を推奨。
  - ブロックコメントは対象コードの直前に置く。長くなる場合は箇条書きで要点のみ。
  - Docstring は公開API/複雑処理のみ（仕様・戻り値・副作用を簡潔に）。

良い例
```python
# 透過ウィンドウは OS によって角が黒く見えることがあるため、
# border-radius に加えてウィンドウマスクで形状を固定する。
path.addRoundedRect(rect, r, r)
```

悪い例
```python
# 角を丸くする
path.addRoundedRect(rect, r, r)  # ← 自明
```

ログとの使い分け
- コメント: 変更理由・設計判断などの「静的な意図」
- ログ: 失敗原因・外部応答・経路分岐など「実行時の事実」

---

この規約は「可読性・安定性・即時性（UI 応答）」を最優先にします。迷った場合は既存コードの流儀に合わせ、分からない点は PR/Issue で相談してください。 

