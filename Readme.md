# 猫型AIマスコット（エド）

デスクトップ上で動く猫（PySide6）。日本語で会話し、吹き出しを表示します。右クリックメニューから操作できます。

## 動作環境
- Windows 10/11（他OSは未検証）
- Python 3.10+

## セットアップ
```powershell
py -m pip install --upgrade pip
py -m pip install -r requirements.txt
```
（失敗する場合は `python -m pip ...` に置き換え）

## 起動
起動方法は用途に応じて選べます。

- コンソール非表示（通常利用・推奨 / Windows）

```powershell
pythonw app.pyw
```

- コンソール表示（デバッグ用）

```powershell
py mascot.py
```

エクスプローラから `app.pyw` をダブルクリックしても起動できます。

## 使い方
- 右クリックメニュー
  - 話しかける…: 右下に入力欄を開きます（フォーカス済み）。
  - 設定…: 設定ダイアログを開きます（保存すると即時反映）。
  - 終了: アプリを終了します。
- 入力欄（右下）
  - Enter: 送信、Esc: 閉じる。
  - 依存が入っていればマイクボタン（🎤）で押している間だけ録音→離すと認識送信（任意）。

補足
- チャットモード（`talk.chat_mode: true`）では、吹き出しの代わりに右下のチャットパネルが開き、履歴が見やすくなります。

## 設定（設定… → GUI）
設定ダイアログは `config/mascot.json` の `ui.tabs[].fields[]` を読み、動的に生成されています。保存すると JSON に書き戻され、即再読込されます。

- 主なタブ
  - マスコット: 画像サイズ、更新周期、移動/停止/睡眠、アニメ間隔など
  - 会話: 吹き出しON/OFF、自動発話間隔、メッセージ一覧
  - ネット: 回答最大文字数、タイムアウト
  - LLM: LM Studioのエンドポイント、モデル名、温度、トークン、システムプロンプト

ポイント
- `ui.enforce_all: true` のため、基本は UI 定義の値（各 field の `value`）が読み込み時に実値へ反映されます。
- 時刻の自動付与は無効（`context.include_time=false`）。必要時だけONにしてください。

## LM Studio との連携
- `config/mascot.json` → `llm.enabled` を `true` にする。
- `llm.base_url` に LM Studio の OpenAI 互換URLを設定（例: `http://localhost:1234/v1`）。
- `llm.model` に使用モデル名（例: `LMStudio-openai/gpt-oss-20b`）。
- 会話は日本語・簡潔を前提。最大文字数は `net.answer_max_chars`（既定: 220）で制御。

## 音声入力（任意）
押している間だけ録音（プッシュトーク）。離すと音声認識→送信します。

依存（任意で導入）:
```powershell
py -m pip install SpeechRecognition sounddevice numpy
```
依存が無い場合はバブルで案内が出ます（通常のテキスト会話はそのまま利用可）。

## 現在の仕様（要点）
- 会話は軽量でシンプル（RAG/検索は未統合）。
- 右クリック「話しかける…」は入力欄を右下に直接表示（サブメニューは廃止）。
- 「入力欄を表示」「右下固定」などの個別メニューは統合/削除済み。
- テストモード/省電力モードは廃止。
- 設定保存時に自動で再読込し、タイマ/アニメ/会話設定を反映。
- UIスレッド以外からのUI操作は行わない（内部シグナルで橋渡し）。

## よくある調整
- 返答が長い/短い: `net.answer_max_chars` を変更（例: 180〜260）。
- 口調がブレる: `llm.temperature` を下げる（0.2〜0.5）。
- 遅い: 小さいモデルを選ぶ、`llm.max_tokens` を下げる、`context_turns` を下げる。

## 既知の制限/今後
- LLM は現在時刻/場所を自動では知りません（`context.include_time` をONにすると注入可能）。
- リアルタイム検索/家電操作/PC操作は未統合（ツール化して「必要時のみ実行」する構成を検討中）。
- 「万能な猫（分類→必要アクション→最終回答）」は、軽量ルータ＋ツール群＋安全確認で段階的に追加予定。

## 参考（設定ファイルの場所）
- 設定: `config/mascot.json`
- 学習メモリ: `data/memory.json`

## ログ
- 起動・例外・LLM通信エラーなどは `logs/edo.log` に記録されます（ローテーションあり）。`app.pyw` からの起動でも確認できます。

## 構成（主要ファイル）
- `app.pyw`: ログ初期化＋アプリ起動（通常のエントリポイント）
- `mascot.py`: マスコット本体（移動/描画/右クリックメニュー）
- `talker.py`: 吹き出し／入力バー／チャットパネル、LLM応答の橋渡し
- `agent/llm.py`: LM Studio(OpenAI互換)への問い合わせ
- `agent/config.py`: 設定の既定値・読み書き
- `agent/memory.py`: 会話履歴・要約等の保存
- `config/mascot.json`: 設定と設定UIの定義
- `material/`: アイコンやスプライト素材

## 開発メモ
- 設定値はコードにハードコードせず、JSONで一元管理（UI定義も同ファイル内）。
- 認識/スレッドからのUI操作はシグナル経由でメインスレッドに委譲しています。